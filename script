parted --script /dev/nvme0n1 mklabel gpt \
  mkpart non-fs 0% 2 \
  mkpart primary 2 514 \
  mkpart primary 514 95%
  set 1 bios_grub on \
  set 1 name boot \
  set 2 boot on \
  set 2 efi on \
  set 2 name EFI
  set 3 name ZFS
zpool create -o ashift=12 \
  -O acltype=posixacl -O canmount=off -O compression=on \
  -O dnodesize=auto -O normalization=formD -O relatime=on -O xattr=sa \
  -O encryption=aes-256-gcm -O keylocation=prompt -O keyformat=passphrase \
  -O mountpoint=none -R /mnt \
  zroot /dev/nvme0n1p3
zfs create -o canmount=off -o mountpoint=none zroot/ROOT
zfs create -o canmount=noauto -o mountpoint=/ zroot/ROOT/arch
zfs mount zroot/ROOT/arch

zfs create -o mountpoint=/home zroot/home
zpool set bootfs=zroot/ROOT/arch zroot
mkfs.vfat -F32 /dev/nvme0n1p2
mkdir /mnt/boot
mount /dev/nvme0n1p2 /mnt/boot
zpool set cachefile=/etc/zfs/zpool.cache zroot
mkdir -p /mnt/etc/zfs/
cp /etc/zfs/zpool.cache /mnt/etc/zfs/zpool.cache
loadkeys pl
timedatectl set-ntp true
genfstab -L -p /mnt | egrep -v "^(zroot|$)" > /mnt/etc/fstab
echo -e '[archzfs]\nSigLevel = Optional TrustAll\nServer   = http://archzfs.com/$repo/x86_64' >> /etc/pacman.conf
cp /etc/pacman.conf /mnt/etc/pacman.conf
pacman-key --init
pacman-key --populate archlinux

pacstrap /mnt base base-devel linux linux-headers linux-firmware amd-ucode
pacstrap /mnt grub efibootmgr lvm2 zfs-dkms zfs-utils mkinitcpio mkinitcpio-netconf mkinitcpio-tinyssh
pacstrap /mnt xorg acpid avahi cups cronie systemd-sysvcompat dhclient neovim
pacstrap /mnt zsh lightdm-gtk-greeter lightdm
arch-chroot /mnt
ln -sf /usr/share/zoneinfo/Europe/Warsaw /etc/localtime
hwclock --systohc
echo -e 'LC_ALL=pl_PL.UTF-8\nLANG=pl_PL.UTF-8' >> /etc/locale.conf
echo -e 'pl_PL.UTF-8 UTF-8\npl_PL.UTF-8 UTF-8' >> /etc/locale.gen
locale-gen
echo 'KEYMAP=pl' > /etc/vconsole.conf
echo archlinux > /etc/hostname
echo -e '127.0.0.1\tlocalhost\n::1\tlocalhost\n127.0.1.1\tarchlinux.home.jack archlinux' >> /etc/hosts
echo 'ssh-ed25519 <PUBKEY>' > /etc/tinyssh/root_key
vim /etc/mkinitcpio.conf
# HOOKS="base udev autodetect modconf block keyboard keymap netconf tinyssh zfsencryptssh zfs filesystems"
mkinitcpio -P
nvim /etc/default/grub
# GRUB_CMDLINE_LINUX_DEFAULT="zfs=zroot/ROOT/arch ip=:::::enp3s0f3u2:dhcp loglevel=3 quiet"

mkdir /boot/grub
ZPOOL_VDEV_NAME_PATH=1 grub-mkconfig -o /boot/grub/grub.cfg
ZPOOL_VDEV_NAME_PATH=1 grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB

